AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  VpcId:
    Type: String
    Default: 'vpc-0efc618f370bd19ed'  # 请替换为您的VPC ID
    Description: VPC ID for deployment
  SubnetIds:
    Type: CommaDelimitedList
    Default: 'subnet-08c751cb066bbbd38,subnet-0851221bd3d89f417'  # 请替换为您的子网ID
    Description: Subnet IDs for deployment
  SupabaseUrl:
    Type: String
    NoEcho: false
    Description: Supabase URL
    Default: ''
  SupabaseKey:
    Type: String
    NoEcho: true
    Description: Supabase anonymous key
    Default: ''
  WalletConnectProjectId:
    Type: String
    NoEcho: true
    Description: WalletConnect Project ID
    Default: ''

Globals:
  Function:
    Timeout: 30
    MemorySize: 1024
    Runtime: nodejs20.x
    Architectures: ['arm64']
    Environment:
      Variables:
        NODE_ENV: 'production'
        NEXT_TELEMETRY_DISABLED: '1'
    EphemeralStorage:
      Size: 512

Resources:
  # 前端Lambda安全组
  FrontendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'Security group for ${AWS::StackName} Frontend Lambda'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS outbound
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP outbound
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: Allow DNS queries
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-frontend-sg'

  # Next.js Lambda函数
  NextjsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .next/
      Handler: server.handler
      MemorySize: 2048
      Timeout: 30
      Policies:
        - S3CrudPolicy:
            BucketName: 'waste-to-nft-assets-prod'
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref FrontendSecurityGroup
        SubnetIds: !Ref SubnetIds
      Environment:
        Variables:
          APP_ENV: 'production'
          NEXT_PUBLIC_SUPABASE_URL: !Ref SupabaseUrl
          NEXT_PUBLIC_SUPABASE_ANON_KEY: !Ref SupabaseKey
          NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: !Ref WalletConnectProjectId
      Events:
        RootEvent:
          Type: Api
          Properties:
            Path: /
            Method: ANY
        ApiEvent:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
      AutoPublishAlias: live

  # S3存储桶用于静态资源
  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: 'waste-to-nft-assets-prod'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      WebsiteConfiguration:
        IndexDocument: index.html
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins: ['*']
            AllowedMethods: [GET, HEAD]
            AllowedHeaders: ['*']

  # S3存储桶策略
  AssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AssetsBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Sub '${AssetsBucket}/*'

Outputs:
  FrontendApiEndpoint:
    Description: Frontend API Gateway endpoint URL
    Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod'
  FrontendFunctionArn:
    Description: Frontend Lambda Function ARN
    Value: !GetAtt NextjsFunction.Arn
  AssetsBucketName:
    Description: S3 bucket for static assets
    Value: !Ref AssetsBucket
  AssetsBucketUrl:
    Description: S3 bucket website URL
    Value: !GetAtt AssetsBucket.WebsiteURL